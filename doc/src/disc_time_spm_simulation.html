<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of disc_time_spm_simulation</title>
  <meta name="keywords" content="disc_time_spm_simulation">
  <meta name="description" content="Copyright (c) 2018 Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html src -->
<h1>disc_time_spm_simulation
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Copyright (c) 2018 Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Copyright (c) 2018 Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;
 Author: Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../src/sim_modular_fcns/AB_matrices_spm_three_states.html" class="code" title="function [A_cts, A_disc, B_cts, B_disc] = AB_matrices_spm_three_states(param,Ts)">AB_matrices_spm_three_states</a>	Copyright (c) 2018 Gopalakrishnan, Krishnakumar <krishnak@vt.edu></li><li><a href="../src/sim_modular_fcns/check_termination.html" class="code" title="function overall_exit_status = check_termination(soc_pct,v_cell,params)">check_termination</a>	Copyright (c) 2018 Gopalakrishnan, Krishnakumar <krishnak@vt.edu></li><li><a href="../src/sim_modular_fcns/parameters_spm_basic.html" class="code" title="function param = parameters_spm_basic(init_cell_soc_percent, cellIdentifier)">parameters_spm_basic</a>	cellIdentifier is a string descriptive of the cell to be simulated.</li><li><a href="../src/sim_modular_fcns/spm_three_states_battery_voltage.html" class="code" title="function v_cell = spm_three_states_battery_voltage(x,u,param)">spm_three_states_battery_voltage</a>	returns v_cell given the vector x and input u at any given time-step</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% Copyright (c) 2018 Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;</span>
0002 <span class="comment">% Author: Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;</span>
0003 
0004 clear;clc; format short g; format compact; close all;
0005 
0006 <span class="comment">%% User-entered data</span>
0007 <span class="comment">% case-sensitive string descriptive of cell to be simulated.</span>
0008 cellIdentifier = <span class="string">'Northrop'</span>;
0009 
0010 <span class="comment">% string describing starting soc% and csv filename of load profile (time vs current through external circuit)</span>
0011 load_profile_name = <span class="string">'cnst_dischg'</span>; <span class="comment">% a) 'cnst_dischg' b) 'cnst_chg' c) 'udds' etc</span>
0012 
0013 <span class="comment">% Input CSV-profile setup. Note: Offsets use a 0-base numbering system</span>
0014 soc_col            = 1; <span class="comment">% The starting SOC is in this column of top row</span>
0015 profile_row_offset = 2; <span class="comment">% Load profile input data begins only from this row</span>
0016 
0017 Ts       = 0.5; <span class="comment">% sec (how often are results needed?)</span>
0018 tf_user  = 1.5; <span class="comment">% sec (user-entered desired simulation end-time)</span>
0019 <span class="comment">% Simulation might prematurely end if voltage/soc cutoffs are hit</span>
0020 
0021 termination_choice = <span class="string">'max'</span>; <span class="comment">% valid choices are 'max' and 'min'</span>
0022 <span class="comment">% The 'min' choice is helpful for trials. Whilst retaining the characteristics</span>
0023 <span class="comment">% of the load profile, the user may do a short time trial simulation.</span>
0024 
0025 <span class="comment">%% Pre-Process user data</span>
0026 profile_filename  = [load_profile_name,<span class="string">'.csv'</span>];
0027 
0028 <span class="comment">% Note: a positive C-rate implies discharge and vice-versa for charge</span>
0029 <span class="keyword">try</span>
0030     C_rate_profile = csvread(profile_filename,profile_row_offset,0);
0031 <span class="keyword">catch</span>
0032     error(<span class="string">'Invalid load profile specified. Quitting simulation ...'</span>);
0033 <span class="keyword">end</span>
0034 
0035 <span class="comment">% Compute expected end-time for allocation of storage &amp; maximum loop indices</span>
0036 <span class="keyword">if</span> strcmp(termination_choice,<span class="string">'max'</span>)
0037     t_finish = max(tf_user,C_rate_profile(<span class="keyword">end</span>,1)); <span class="comment">% longer of the two prevails</span>
0038     <span class="comment">% If the last time-entry in the input csv file is shorter than user-entered</span>
0039     <span class="comment">% value, then the last C-rate from the csv file is held for rest of the</span>
0040     <span class="comment">% simulation.</span>
0041 <span class="keyword">elseif</span> strcmp(termination_choice,<span class="string">'min'</span>)
0042     t_finish = min(tf_user,C_rate_profile(<span class="keyword">end</span>,1)); <span class="comment">% longer of the two prevails</span>
0043 <span class="keyword">else</span>
0044     error(&quot;Invalid termination choice. Valid strings are: <span class="string">'max'</span> or <span class="string">'min'</span>.&quot;);
0045 <span class="keyword">end</span>
0046 
0047 <span class="comment">% Starting SoC percentage</span>
0048 soc_init_pct = csvread(profile_filename,0,soc_col,[0 soc_col 0 soc_col]);
0049 
0050 <span class="comment">% struct of cell parameters</span>
0051 spm_params = <a href="../src/sim_modular_fcns/parameters_spm_basic.html" class="code" title="function param = parameters_spm_basic(init_cell_soc_percent, cellIdentifier)">parameters_spm_basic</a>(soc_init_pct,cellIdentifier);
0052 
0053 I_1C = spm_params.I_1C;
0054 clear tf_user profile_row_offset soc_col profile_filename termination_choice;
0055 
0056 <span class="comment">%% Pre-Compute the System and Input Matrices</span>
0057 [~, A_disc, ~, B_disc] = <a href="../src/sim_modular_fcns/AB_matrices_spm_three_states.html" class="code" title="function [A_cts, A_disc, B_cts, B_disc] = AB_matrices_spm_three_states(param,Ts)">AB_matrices_spm_three_states</a>(spm_params,Ts);
0058 outputEqn  = @<a href="../src/sim_modular_fcns/spm_three_states_battery_voltage.html" class="code" title="function v_cell = spm_three_states_battery_voltage(x,u,param)">spm_three_states_battery_voltage</a>;
0059 
0060 <span class="comment">%% Allocate storage for simulated quantities</span>
0061 num_iterations = ceil(t_finish/Ts) + 1; <span class="comment">% max no. of steps (assuming no cutoff)</span>
0062 
0063 spm_sim_time_vector        = nan(num_iterations,1);
0064 load_current_vector        = nan(num_iterations,1);
0065 v_cell_sim_results_spm     = nan(num_iterations,1);
0066 soc_pct_results_spm        = nan(num_iterations,1);
0067 cs_avg_neg_sim_results_spm = nan(num_iterations,1);
0068 q_pos_sim_results_spm      = nan(num_iterations,1);
0069 q_neg_sim_results_spm      = nan(num_iterations,1);
0070 
0071 <span class="comment">%% Initialise SPM state vector and all other simulated quantities</span>
0072 spm_sim_time_vector(1)        = 0;
0073 soc_pct_results_spm(1)        = soc_init_pct;
0074 cs_avg_neg_sim_results_spm(1) = spm_params.cs_n_init;
0075 q_pos_sim_results_spm(1)      = 0;
0076 q_neg_sim_results_spm(1)      = 0;
0077 
0078 <span class="comment">% load current applied at t = t0</span>
0079 load_current_vector(1) = I_1C*interp1(C_rate_profile(:,1),C_rate_profile(:,2),spm_sim_time_vector(1),<span class="string">'previous'</span>,<span class="string">'extrap'</span>);
0080 
0081 x_spm_init = [q_pos_sim_results_spm(1); <span class="keyword">...</span>
0082               q_neg_sim_results_spm(1); <span class="keyword">...</span>
0083               cs_avg_neg_sim_results_spm(1)];
0084 
0085 v_cell_sim_results_spm(1) = outputEqn(x_spm_init,load_current_vector(1),spm_params);
0086 
0087 t_local_finish     = Ts;
0088 x_spm_local_finish = x_spm_init;
0089 
0090 clear x_init t_finish q_pos_init q_neg_init;
0091 
0092 <span class="comment">%% Simulate the SPM</span>
0093 progressbarText(0);
0094 
0095 <span class="keyword">for</span> k = 2:num_iterations  <span class="comment">% Need solution at k-th time-step</span>
0096     load_current_vector(k)        = I_1C*interp1(C_rate_profile(:,1),C_rate_profile(:,2),spm_sim_time_vector(1),<span class="string">'previous'</span>,<span class="string">'extrap'</span>); <span class="comment">% load current that was held constant from (k-1) to (k)</span>
0097     x_spm_local_finish            = A_disc*x_spm_local_finish + B_disc*load_current_vector(k);
0098 
0099     q_pos_sim_results_spm(k)      = x_spm_local_finish(1);
0100     q_neg_sim_results_spm(k)      = x_spm_local_finish(2);
0101     cs_avg_neg_sim_results_spm(k) = x_spm_local_finish(3);
0102 
0103     soc_pct_results_spm(k)        = 100*((cs_avg_neg_sim_results_spm(k)/spm_params.cs_max_n) - spm_params.theta_min_neg)/(spm_params.theta_max_neg - spm_params.theta_min_neg);
0104     v_cell_sim_results_spm(k)     = outputEqn(x_spm_local_finish,load_current_vector(k),spm_params);
0105 
0106     overall_exit_status = <a href="../src/sim_modular_fcns/check_termination.html" class="code" title="function overall_exit_status = check_termination(soc_pct,v_cell,params)">check_termination</a>(soc_pct_results_spm(k),v_cell_sim_results_spm(k),spm_params);
0107     <span class="keyword">if</span> overall_exit_status ~= 0 <span class="comment">% check for violation of cut-off conditions</span>
0108         k = k - 1; <span class="comment">% Values in the last simulated index are incorrect.</span>
0109         fprintf(<span class="string">'Exiting simulation ...\n'</span>);
0110         <span class="keyword">break</span>;
0111     <span class="keyword">end</span>
0112 
0113     spm_sim_time_vector(k) = t_local_finish;
0114     t_local_start          = t_local_finish;
0115     t_local_finish         = t_local_start + Ts;
0116     progressbarText((k-1)/num_iterations);
0117 <span class="keyword">end</span>
0118 fprintf(<span class="string">'\n'</span>);
0119 
0120 spm_sim_time_vector        = spm_sim_time_vector(1:k);
0121 load_current_vector        = load_current_vector(1:k);
0122 q_pos_sim_results_spm      = q_pos_sim_results_spm(1:k);
0123 q_neg_sim_results_spm      = q_neg_sim_results_spm(1:k);
0124 cs_avg_neg_sim_results_spm = cs_avg_neg_sim_results_spm(1:k);
0125 soc_pct_results_spm        = soc_pct_results_spm(1:k);
0126 v_cell_sim_results_spm     = v_cell_sim_results_spm(1:k);
0127 
0128 <span class="comment">%% Save results to disk</span>
0129 <span class="keyword">if</span> exist(<span class="string">'spm_results'</span>,<span class="string">'dir'</span>)==0
0130     mkdir(<span class="string">'spm_results'</span>);
0131 <span class="keyword">end</span>
0132 
0133 <span class="comment">% Replace decimal point chars in soc% string with 'p' (stands for point)</span>
0134 soc_init_pct_savestr = strrep(num2str(soc_init_pct),<span class="string">'.'</span>,<span class="string">'p'</span>);
0135 
0136 <span class="comment">% clear A_disc B_disc; % potentially useful varibles. comment out for debugging</span>
0137 clear soc_init_pct C_rate_profile I_1C k num_iterations; <span class="comment">% redundant info</span>
0138 clear x_spm_init x_spm_local_finish t_local_finish t_local_start;
0139 save([<span class="string">'spm_results/disc_sim_'</span>, cellIdentifier, <span class="string">'_'</span>, load_profile_name, <span class="keyword">...</span>
0140       <span class="string">'_initial_soc_'</span>, soc_init_pct_savestr, <span class="string">'pct'</span>, <span class="keyword">...</span>
0141       datestr(now, <span class="string">'_mmm_dd_yyyy_HH_MM_SS'</span>)]); <span class="comment">% save workspace to file</span>
0142 
0143 <span class="comment">%% Plot results</span>
0144 close all;
0145 figure(1);
0146 h1 = subplot(211);
0147 plot(spm_sim_time_vector,load_current_vector,<span class="string">'-'</span>);
0148 ylabel(<span class="string">'Current'</span>);
0149 ylim([min(load_current_vector)-5 max(load_current_vector)+5]);
0150 
0151 h2 = subplot(212);
0152 plot(spm_sim_time_vector,v_cell_sim_results_spm,<span class="string">'m'</span>);
0153 ylim([spm_params.CutoffVoltage spm_params.CutoverVoltage]);
0154 ylabel(<span class="string">'Cell Voltage [V]'</span>);
0155 
0156 linkaxes([h1 h2],<span class="string">'x'</span>);
0157 xlim([spm_sim_time_vector(1) spm_sim_time_vector(end)]);
0158 xlabel(<span class="string">'Time [sec]'</span>);
0159 
0160 
0161 figure(2);
0162 h1 = subplot(211);
0163 plot(spm_sim_time_vector,load_current_vector,<span class="string">'-'</span>);
0164 ylabel(<span class="string">'Current'</span>);
0165 ylim([min(load_current_vector)-5 max(load_current_vector)+5]);
0166 
0167 h2 = subplot(212);
0168 plot(spm_sim_time_vector,soc_pct_results_spm,<span class="string">'r'</span>);
0169 ylabel(<span class="string">'SOC [%]'</span>);
0170 
0171 linkaxes([h1 h2],<span class="string">'x'</span>);
0172 xlim([spm_sim_time_vector(1) spm_sim_time_vector(end)]);
0173 xlabel(<span class="string">'Time [sec]'</span>);
0174 
0175 clear h1 h2;
0176 figure(1);
0177 shg;
0178</pre></div>
<hr><address>Generated on Sat 26-May-2018 17:01:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>