<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of cts_time_spm_simulation</title>
  <meta name="keywords" content="cts_time_spm_simulation">
  <meta name="description" content="Copyright (c) 2018 Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html src -->
<h1>cts_time_spm_simulation
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Copyright (c) 2018 Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Copyright (c) 2018 Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;
 Author: Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../src/sim_modular_fcns/check_termination.html" class="code" title="function overall_exit_status = check_termination(soc_pct,v_cell,params)">check_termination</a>	Copyright (c) 2018 Gopalakrishnan, Krishnakumar <krishnak@vt.edu></li><li><a href="../src/sim_modular_fcns/cts_time_specific_supporting_fcns/spm_cts_stateEqn_three_states.html" class="code" title="function dx_dt = spm_cts_stateEqn_three_states(x,u,param)">spm_cts_stateEqn_three_states</a>	returns dx_dt given the vector x and input u at any given time-step</li><li><a href="../src/sim_modular_fcns/parameters_spm_basic.html" class="code" title="function param = parameters_spm_basic(init_cell_soc_percent, cellIdentifier)">parameters_spm_basic</a>	cellIdentifier is a string descriptive of the cell to be simulated.</li><li><a href="../src/sim_modular_fcns/spm_three_states_battery_voltage.html" class="code" title="function v_cell = spm_three_states_battery_voltage(x,u,param)">spm_three_states_battery_voltage</a>	returns v_cell given the vector x and input u at any given time-step</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% Copyright (c) 2018 Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;</span>
0002 <span class="comment">% Author: Gopalakrishnan, Krishnakumar &lt;krishnak@vt.edu&gt;</span>
0003 
0004 clear;clc; format short g; format compact; close all;
0005 
0006 <span class="comment">%% User-entered data</span>
0007 <span class="comment">% case-sensitive string descriptive of cell to be simulated.</span>
0008 cellIdentifier = <span class="string">'Northrop'</span>;
0009 
0010 <span class="comment">% string describing starting soc% and csv filename of load profile (time vs current through external circuit)</span>
0011 load_profile_name = <span class="string">'cnst_dischg'</span>; <span class="comment">% a) 'cnst_dischg' b) 'cnst_chg' c) 'udds' etc</span>
0012 
0013 <span class="comment">% Input CSV-profile setup. Note: Offsets use a 0-base numbering system</span>
0014 soc_col            = 1; <span class="comment">% The starting SOC is in this column of top row</span>
0015 profile_row_offset = 2; <span class="comment">% Load profile input data begins only from this row</span>
0016 
0017 Ts       = 0.5; <span class="comment">% sec (how often are results needed?)</span>
0018 tf_user  = 1.5; <span class="comment">% sec (user-entered desired simulation end-time)</span>
0019 <span class="comment">% Simulation might prematurely end if voltage/soc cutoffs are hit</span>
0020 
0021 termination_choice = <span class="string">'max'</span>; <span class="comment">% valid choices are 'max' and 'min'</span>
0022 <span class="comment">% The 'min' choice is helpful for trials. Whilst retaining the characteristics</span>
0023 <span class="comment">% of the load profile, the user may do a short time trial simulation.</span>
0024 
0025 <span class="comment">%% Pre-Process user data</span>
0026 profile_filename  = [load_profile_name,<span class="string">'.csv'</span>];
0027 
0028 <span class="comment">% Note: a positive C-rate implies discharge and vice-versa for charge</span>
0029 <span class="keyword">try</span>
0030     C_rate_profile = csvread(profile_filename,profile_row_offset,0);
0031 <span class="keyword">catch</span>
0032     error(<span class="string">'Invalid load profile specified. Quitting simulation ...'</span>);
0033 <span class="keyword">end</span>
0034 
0035 <span class="comment">% Compute expected end-time for allocation of storage &amp; maximum loop indices</span>
0036 <span class="keyword">if</span> strcmp(termination_choice,<span class="string">'max'</span>)
0037     t_finish = max(tf_user,C_rate_profile(<span class="keyword">end</span>,1)); <span class="comment">% longer of the two prevails</span>
0038     <span class="comment">% If the last time-entry in the input csv file is shorter than user-entered</span>
0039     <span class="comment">% value, then the last C-rate from the csv file is held for rest of the</span>
0040     <span class="comment">% simulation.</span>
0041 <span class="keyword">elseif</span> strcmp(termination_choice,<span class="string">'min'</span>)
0042     t_finish = min(tf_user,C_rate_profile(<span class="keyword">end</span>,1)); <span class="comment">% longer of the two prevails</span>
0043 <span class="keyword">else</span>
0044     error(&quot;Invalid termination choice. Valid strings are: <span class="string">'max'</span> or <span class="string">'min'</span>.&quot;);
0045 <span class="keyword">end</span>
0046 
0047 <span class="comment">% Starting SoC percentage</span>
0048 soc_init_pct = csvread(profile_filename,0,soc_col,[0 soc_col 0 soc_col]);
0049 
0050 <span class="comment">% struct of cell parameters</span>
0051 spm_params = <a href="../src/sim_modular_fcns/parameters_spm_basic.html" class="code" title="function param = parameters_spm_basic(init_cell_soc_percent, cellIdentifier)">parameters_spm_basic</a>(soc_init_pct,cellIdentifier);
0052 
0053 I_1C = spm_params.I_1C;
0054 clear tf_user profile_row_offset soc_col profile_filename termination_choice;
0055 
0056 <span class="comment">%% Define the State-eqn  and Output equation for simulation</span>
0057 stateEqn   = @<a href="../src/sim_modular_fcns/cts_time_specific_supporting_fcns/spm_cts_stateEqn_three_states.html" class="code" title="function dx_dt = spm_cts_stateEqn_three_states(x,u,param)">spm_cts_stateEqn_three_states</a>;
0058 outputEqn  = @<a href="../src/sim_modular_fcns/spm_three_states_battery_voltage.html" class="code" title="function v_cell = spm_three_states_battery_voltage(x,u,param)">spm_three_states_battery_voltage</a>;
0059 
0060 <span class="comment">%% Allocate storage for simulated quantities</span>
0061 num_iterations = ceil(t_finish/Ts) + 1; <span class="comment">% max no. of steps (assuming no cutoff)</span>
0062 
0063 spm_sim_time_vector        = nan(num_iterations,1);
0064 load_current_vector        = nan(num_iterations,1);
0065 v_cell_sim_results_spm     = nan(num_iterations,1);
0066 soc_pct_results_spm        = nan(num_iterations,1);
0067 cs_avg_neg_sim_results_spm = nan(num_iterations,1);
0068 q_pos_sim_results_spm      = nan(num_iterations,1);
0069 q_neg_sim_results_spm      = nan(num_iterations,1);
0070 
0071 <span class="comment">%% Initialise SPM state vector and all other simulated quantities</span>
0072 spm_sim_time_vector(1)        = 0;
0073 soc_pct_results_spm(1)        = soc_init_pct;
0074 cs_avg_neg_sim_results_spm(1) = spm_params.cs_n_init;
0075 q_pos_sim_results_spm(1)      = 0;
0076 q_neg_sim_results_spm(1)      = 0;
0077 
0078 <span class="comment">% load current applied at t = t0</span>
0079 load_current_vector(1) = I_1C*interp1(C_rate_profile(:,1),C_rate_profile(:,2),spm_sim_time_vector(1),<span class="string">'previous'</span>,<span class="string">'extrap'</span>);
0080 
0081 x_spm_init = [q_pos_sim_results_spm(1); <span class="keyword">...</span>
0082               q_neg_sim_results_spm(1); <span class="keyword">...</span>
0083               cs_avg_neg_sim_results_spm(1)];
0084 
0085 v_cell_sim_results_spm(1) = outputEqn(x_spm_init,load_current_vector(1),spm_params);
0086 
0087 t_local_start      = 0;
0088 t_local_finish     = Ts;
0089 x_spm_local_finish = x_spm_init;
0090 
0091 clear x_init t_finish q_pos_init q_neg_init;
0092 
0093 <span class="comment">%% Simulate the SPM</span>
0094 progressbarText(0);
0095 
0096 <span class="keyword">for</span> k = 2:num_iterations  <span class="comment">% Need solution at k-th time-step</span>
0097     load_current_vector(k)        = I_1C*interp1(C_rate_profile(:,1),C_rate_profile(:,2),spm_sim_time_vector(1),<span class="string">'previous'</span>,<span class="string">'extrap'</span>); <span class="comment">% load current that was held constant from (k-1) to (k)</span>
0098     t_span                        = [t_local_start t_local_finish];
0099     [~,x_spm_local_finish_matrix] = ode45(@(t,x_spm_local_finish) stateEqn(x_spm_local_finish,load_current_vector(k),spm_params), t_span, x_spm_local_finish);
0100     x_spm_local_finish            = x_spm_local_finish_matrix(<span class="keyword">end</span>,:)';
0101 
0102     q_pos_sim_results_spm(k)      = x_spm_local_finish(1);
0103     q_neg_sim_results_spm(k)      = x_spm_local_finish(2);
0104     cs_avg_neg_sim_results_spm(k) = x_spm_local_finish(3);
0105 
0106     soc_pct_results_spm(k)        = 100*((cs_avg_neg_sim_results_spm(k)/spm_params.cs_max_n) - spm_params.theta_min_neg)/(spm_params.theta_max_neg - spm_params.theta_min_neg);
0107     v_cell_sim_results_spm(k)     = outputEqn(x_spm_local_finish,load_current_vector(k),spm_params);
0108 
0109     overall_exit_status = <a href="../src/sim_modular_fcns/check_termination.html" class="code" title="function overall_exit_status = check_termination(soc_pct,v_cell,params)">check_termination</a>(soc_pct_results_spm(k),v_cell_sim_results_spm(k),spm_params);
0110     <span class="keyword">if</span> overall_exit_status ~= 0 <span class="comment">% check for violation of cut-off conditions</span>
0111         k = k - 1; <span class="comment">% Values in the last simulated index are incorrect.</span>
0112         fprintf(<span class="string">'Exiting simulation ...\n'</span>);
0113         <span class="keyword">break</span>;
0114     <span class="keyword">end</span>
0115 
0116     spm_sim_time_vector(k) = t_local_finish;
0117     t_local_start          = t_local_finish;
0118     t_local_finish         = t_local_start + Ts;
0119     progressbarText((k-1)/num_iterations);
0120 <span class="keyword">end</span>
0121 fprintf(<span class="string">'\n'</span>);
0122 
0123 spm_sim_time_vector        = spm_sim_time_vector(1:k);
0124 load_current_vector        = load_current_vector(1:k);
0125 q_pos_sim_results_spm      = q_pos_sim_results_spm(1:k);
0126 q_neg_sim_results_spm      = q_neg_sim_results_spm(1:k);
0127 cs_avg_neg_sim_results_spm = cs_avg_neg_sim_results_spm(1:k);
0128 soc_pct_results_spm        = soc_pct_results_spm(1:k);
0129 v_cell_sim_results_spm     = v_cell_sim_results_spm(1:k);
0130 
0131 <span class="comment">%% Save results to disk</span>
0132 <span class="keyword">if</span> exist(<span class="string">'spm_results'</span>,<span class="string">'dir'</span>)==0
0133     mkdir(<span class="string">'spm_results'</span>);
0134 <span class="keyword">end</span>
0135 
0136 <span class="comment">% Replace decimal point chars in soc% string with 'p' (stands for point)</span>
0137 soc_init_pct_savestr = strrep(num2str(soc_init_pct),<span class="string">'.'</span>,<span class="string">'p'</span>);
0138 
0139 <span class="comment">% clear A_disc B_disc; % potentially useful varibles. comment out for debugging</span>
0140 clear soc_init_pct C_rate_profile I_1C k num_iterations; <span class="comment">% redundant info</span>
0141 clear x_spm_init x_spm_local_finish t_local_finish t_local_start;
0142 save([<span class="string">'spm_results/cts_sim_'</span>, cellIdentifier, <span class="string">'_'</span>, load_profile_name, <span class="keyword">...</span>
0143       <span class="string">'_initial_soc_'</span>, soc_init_pct_savestr, <span class="string">'pct'</span>, <span class="keyword">...</span>
0144       datestr(now, <span class="string">'_mmm_dd_yyyy_HH_MM_SS'</span>)]); <span class="comment">% save workspace to file</span>
0145 
0146 <span class="comment">%% Plot results</span>
0147 close all;
0148 figure(1);
0149 h1 = subplot(211);
0150 plot(spm_sim_time_vector,load_current_vector,<span class="string">'-'</span>);
0151 ylabel(<span class="string">'Current'</span>);
0152 ylim([min(load_current_vector)-5 max(load_current_vector)+5]);
0153 
0154 h2 = subplot(212);
0155 plot(spm_sim_time_vector,v_cell_sim_results_spm,<span class="string">'m'</span>);
0156 ylim([spm_params.CutoffVoltage spm_params.CutoverVoltage]);
0157 ylabel(<span class="string">'Cell Voltage [V]'</span>);
0158 
0159 linkaxes([h1 h2],<span class="string">'x'</span>);
0160 xlim([spm_sim_time_vector(1) spm_sim_time_vector(end)]);
0161 xlabel(<span class="string">'Time [sec]'</span>);
0162 
0163 
0164 figure(2);
0165 h1 = subplot(211);
0166 plot(spm_sim_time_vector,load_current_vector,<span class="string">'-'</span>);
0167 ylabel(<span class="string">'Current'</span>);
0168 ylim([min(load_current_vector)-5 max(load_current_vector)+5]);
0169 
0170 h2 = subplot(212);
0171 plot(spm_sim_time_vector,soc_pct_results_spm,<span class="string">'r'</span>);
0172 ylabel(<span class="string">'SOC [%]'</span>);
0173 
0174 linkaxes([h1 h2],<span class="string">'x'</span>);
0175 xlim([spm_sim_time_vector(1) spm_sim_time_vector(end)]);
0176 xlabel(<span class="string">'Time [sec]'</span>);
0177 
0178 clear h1 h2;
0179 figure(1);
0180 shg;
0181</pre></div>
<hr><address>Generated on Sat 26-May-2018 17:01:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>